<div class="widget-content">
    <div class="container-fluid">
        <div class="grid-stack-item-handle">
            <h1 class="h5"><span data-bind="text: collection"></span> <small class="text-muted ms-auto">Image Collection</small></h1>
        </div>
        <div class="d-flex flex-row align-items-center">
            <button type="button" class="btn btn-sm btn-outline-secondary" data-bind="click: first_image" title="First image"><span class="bi-skip-backward-fill"></span></button>
            <button type="button" class="ms-1 btn btn-sm btn-outline-secondary" data-bind="click: previous_image" title="Previous image"><span class="bi-skip-start-fill"></span></button>
            <button type="button" class="ms-1 btn btn-sm btn-outline-secondary" data-bind="click: random_image" title="Random image"><span class="bi-shuffle"></span></button>
            <button type="button" class="ms-1 btn btn-sm btn-outline-secondary" data-bind="click: next_image" title="Next image"><span class="bi-skip-end-fill"></span></button>
            <button type="button" class="ms-1 btn btn-sm btn-outline-secondary" data-bind="click: last_image" title="Last image"><span class="bi-skip-forward-fill"></span></button>

            <span class="ms-1">Image <span data-bind="text: index() + 1"></span>/<span data-bind="text: count"></span></span>

            <!--<samlab-favorite-control params="otype: 'observations', oid: observation.id"></samlab-favorite-control>-->
            <div class="dropdown ms-auto">
                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-boundary="window">View</button>
                <div class="dropdown-menu">
                    <a class="dropdown-item" data-bind="click: $component.open_image"><span class="bi-card-image"></span>&nbsp;Standalone image</a>
                    <a class="dropdown-item" data-bind="click: $component.bboxes_toggle"><span class="bi-bounding-box"></span>&nbsp;Bounding boxes</a>
                    <a class="dropdown-item" data-bs-toggle="collapse" data-bind="attr: {'data-bs-target': '#' + metaid()}"><span class="bi-list-nested"></span>&nbsp;Metadata</a>
                    <a class="dropdown-item" data-bs-toggle="collapse" data-bind="attr: {'data-bs-target': '#' + tagid()}"><span class="bi-tags-fill"></span>&nbsp;Tags</a>
                </div>
            </div>
        </div>

        <hr></hr>

        <div class="collapse" data-bind="attr: {id: bboxes_id}, css: {show: bboxes_visible}">
            <div class="d-flex flex-row align-items-center mb-2">
                <div><span class="bi-bounding-box"></span>&nbsp;Mode:</div>
                <samlab-combo-control class="ms-2" params="current: bboxes_mode, items: bboxes_mode_items"></samlab-combo-control>
            </div>
        </div>

        <div class="accordion collapse mb-2" data-bind="attr: {id: tagid}">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bind="attr: {'data-bs-target': '#' + edittagid()}">Tags
                        <span data-bind="foreach: tags">
                            <span class="badge bg-primary ms-2"><span class="bi-tag-fill"></span>&nbsp;<span data-bind="text: $data"></span></span>
                        </span>
                    </button>
                </h2>
                <div class="accordion-collapse collapse" data-bind="attr: {id: edittagid}">
                    <div class="accordion-body">
                        <strong>This will become the UI for assigning and editing tags.</strong>
                        It will be populated with a list of tags from the image
                        collection, plus tags added through the UI, plus UI to
                        add new tags.  Clicking on a tag in the list will toggle
                        its state for the current image.  Tags will be listed in
                        alphabetical order, and the first 10 will have hotkeys
                        assigned.
                    </div>
                </div>
            </div>
        </div>

        <div class="img-overlay-wrap">
            <img class="rounded" data-bind="attr: {src: uri}, event: {load: on_imageloaded}"></img>
            <!-- ko if: bboxes_visible-->
            <svg data-bind="attr: {viewBox: viewbox}, event: {mousedown: on_mousedown, mousemove: on_mousemove, mouseup: on_mouseup}" font-size="12" stroke-width="1">
                <defs>
                    <filter id="shadow">
                        <feDropShadow dx="0.2" dy="0.2" stdDeviation="0.2"/>
                    </filter>
                </defs>
                <!-- ko if: bboxes_mode() == 'add' -->
                <line style="pointer-events: none" x1="0" data-bind="attr:{y1: mousey, y2: mousey, x2: width, stroke: color}" opacity="0.5"/>
                <line style="pointer-events: none" y1="0", data-bind="attr:{x1: mousex, x2: mousex, y2: height, stroke: color}" opacity="0.5"/>
                <!-- /ko -->

                <!-- ko foreach: bboxes -->
                <rect fill-opacity="0.2" data-bind="attr: {x:left, y:top, width:width, height:height, fill:color, stroke:color}, style: {'pointer-events': $component.bboxes_mode() == 'delete' ? 'auto' : 'none'}, click: $parent.bbox_click"/>
                <text style="pointer-events: none; filter:url(#shadow)" stroke="none" data-bind="attr: {x:left()+3, y:top()+12, fill:color}, text:category"/>
                <text style="pointer-events: none; filter:url(#shadow); text-anchor: end" stroke="none" data-bind="attr: {x:left()+width()-3, y:top()+height()-12, fill:color}, text:username"/>
                <!-- /ko -->
            </svg>
            <!-- /ko -->
        </div>

        <div class="col collapse mb-2" data-bind="attr: {id: metaid}">
            <pre><textarea class="form-control" data-bind="text: metadata" rows="6" readonly></textarea></pre>
        </div>
    </div>
</div>
